# –†–µ–∞–ª–∏–∑–∞—Ü–∏—è ClientID –¥–ª—è –æ—Ñ—Ñ–ª–∞–π–Ω-–∫–æ–Ω–≤–µ—Ä—Å–∏–π

## üìã –û–±–∑–æ—Ä –∏–∑–º–µ–Ω–µ–Ω–∏–π

–î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–ª–Ω–∞—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø–µ—Ä–µ–¥–∞—á–∞ –æ—Ñ—Ñ–ª–∞–π–Ω-–∫–æ–Ω–≤–µ—Ä—Å–∏–π –≤ –Ø–Ω–¥–µ–∫—Å.–ú–µ—Ç—Ä–∏–∫—É —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º ClientID –¥–ª—è —Å–≤—è–∑–∏ —Ä–µ–∫–ª–∞–º–Ω—ã—Ö –∫–ª–∏–∫–æ–≤ –∏ –∫–æ–Ω–≤–µ—Ä—Å–∏–π.

## üîÑ –ß—Ç–æ –±—ã–ª–æ –∏–∑–º–µ–Ω–µ–Ω–æ

### 1. `core/yandex_metrika.py`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ `send_offline_conversion`:**
- –¢–µ–ø–µ—Ä—å –ø—Ä–∏–Ω–∏–º–∞–µ—Ç `client_id` (—Å—Ç—Ä–æ–∫–∞) –≤–º–µ—Å—Ç–æ `user_id` (int)
- –î–æ–±–∞–≤–ª–µ–Ω –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä `user_id` –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
- –£–ª—É—á—à–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º ClientID

**–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ wrapper-—Ñ—É–Ω–∫—Ü–∏—è—Ö:**
```python
# –°—Ç–∞—Ä–∞—è –≤–µ—Ä—Å–∏—è
async def send_offline_conversion_bot_start(user_id: int)
async def send_offline_conversion_free_period(user_id: int)
async def send_offline_conversion_payment(user_id: int, amount_kopecks: int)

# –ù–æ–≤–∞—è –≤–µ—Ä—Å–∏—è
async def send_offline_conversion_bot_start(client_id: str, user_id: int)
async def send_offline_conversion_free_period(client_id: str, user_id: int)
async def send_offline_conversion_payment(client_id: str, user_id: int, amount_kopecks: int)
```

–í—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Ç–µ–ø–µ—Ä—å:
- –ü—Ä–∏–Ω–∏–º–∞—é—Ç `client_id` –ø–µ—Ä–≤—ã–º –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º
- –î–æ–±–∞–≤–ª–µ–Ω `try-except` —Å –¥–µ—Ç–∞–ª—å–Ω—ã–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º
- –õ–æ–≥–∏—Ä—É—é—Ç —É—Å–ø–µ—Ö (‚úÖ) –∏–ª–∏ –Ω–µ—É–¥–∞—á—É (‚ùå)

### 2. `handlers/start.py`

**–ü–∞—Ä—Å–∏–Ω–≥ ClientID –∏–∑ UTM:**
```python
# –ò–∑–≤–ª–µ–∫–∞–µ–º ClientID –∏–∑ UTM –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ (yclid –∏–ª–∏ client_id)
metrika_client_id = start_params.get('yclid') or start_params.get('client_id', '')

# –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π ClientID
from core.yandex_metrika import generate_client_id
if metrika_client_id:
    client_id = metrika_client_id  # –ò–∑ —Ä–µ–∫–ª–∞–º—ã
else:
    client_id = generate_client_id(user_id)  # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º
```

**–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ ClientID:**
```python
user_data['client_id'] = client_id
```

**–û—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–Ω–≤–µ—Ä—Å–∏–∏ —Å ClientID:**
```python
client_id = user_data.get('client_id')
if client_id:
    asyncio.create_task(send_offline_conversion_bot_start(client_id, user_id))
else:
    logging.warning(f"ClientID –Ω–µ –Ω–∞–π–¥–µ–Ω –¥–ª—è user_id={user_id}")
```

**–ì–µ–Ω–µ—Ä–∞—Ü–∏—è ClientID –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:**
```python
if not user_data.get('client_id'):
    from core.yandex_metrika import generate_client_id
    user_data['client_id'] = generate_client_id(user_id)
```

### 3. `handlers/subscription.py`

**–ê–∫—Ç–∏–≤–∞—Ü–∏—è –±–µ—Å–ø–ª–∞—Ç–Ω–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞:**
```python
client_id = user_data.get('client_id')
if client_id:
    asyncio.create_task(send_offline_conversion_free_period(client_id, user_id))
    logging.info(f"–û—Ñ—Ñ–ª–∞–π–Ω-–∫–æ–Ω–≤–µ—Ä—Å–∏—è free_period_start –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∞ –¥–ª—è user_id={user_id}, ClientID={client_id}")
else:
    logging.warning(f"ClientID –Ω–µ –Ω–∞–π–¥–µ–Ω –¥–ª—è user_id={user_id}")
```

**–£—Å–ø–µ—à–Ω–∞—è –æ–ø–ª–∞—Ç–∞:**
```python
client_id = user_data.get('client_id')
if client_id:
    asyncio.create_task(send_offline_conversion_payment(client_id, user_id, payment_info.total_amount))
    logging.info(f"–û—Ñ—Ñ–ª–∞–π–Ω-–∫–æ–Ω–≤–µ—Ä—Å–∏—è premium_payment –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∞ –¥–ª—è user_id={user_id}, ClientID={client_id}, amount={payment_info.total_amount / 100} RUB")
else:
    logging.warning(f"ClientID –Ω–µ –Ω–∞–π–¥–µ–Ω –¥–ª—è user_id={user_id}")
```

### 4. `docs/YANDEX_METRIKA_SETUP.md`

–î–æ–±–∞–≤–ª–µ–Ω–∞ –Ω–æ–≤–∞—è —Å–µ–∫—Ü–∏—è **"üîó UTM-—Ç—Ä–µ–∫–∏–Ω–≥ –∏ ClientID"** —Å:
- –û–±—ä—è—Å–Ω–µ–Ω–∏–µ–º, —á—Ç–æ —Ç–∞–∫–æ–µ ClientID
- –ö–∞–∫ ClientID —Å–≤—è–∑—ã–≤–∞–µ—Ç —Ä–µ–∫–ª–∞–º—É –∏ –∫–æ–Ω–≤–µ—Ä—Å–∏–∏
- –§–æ—Ä–º–∞—Ç—ã UTM-—Å—Å—ã–ª–æ–∫ –¥–ª—è —Ä–µ–∫–ª–∞–º—ã
- –ü—Ä–∏–º–µ—Ä—ã –¥–ª—è –Ø–Ω–¥–µ–∫—Å.–î–∏—Ä–µ–∫—Ç

–û–±–Ω–æ–≤–ª–µ–Ω—ã —Å–µ–∫—Ü–∏–∏:
- **–û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º—ã–µ –∫–æ–Ω–≤–µ—Ä—Å–∏–∏** - –¥–æ–±–∞–≤–ª–µ–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ ClientID
- **–õ–æ–≥–∏ –±–æ—Ç–∞** - –ø—Ä–∏–º–µ—Ä—ã –ª–æ–≥–æ–≤ —Å ClientID
- **–ê–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö** - –Ω–æ–≤—ã–µ –æ—Ç—á–µ—Ç—ã –ø–æ ROI –∏ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º —Ç—Ä–∞—Ñ–∏–∫–∞

## üîç –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–∑ —Ä–µ–∫–ª–∞–º—ã (–Ø–Ω–¥–µ–∫—Å.–î–∏—Ä–µ–∫—Ç)

1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∫–ª–∏–∫–∞–µ—Ç –Ω–∞ —Ä–µ–∫–ª–∞–º—É –≤ –Ø–Ω–¥–µ–∫—Å.–î–∏—Ä–µ–∫—Ç
2. –Ø–Ω–¥–µ–∫—Å.–ú–µ—Ç—Ä–∏–∫–∞ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –∫–ª–∏–∫ —Å ClientID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (yclid)
3. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –≤ –±–æ—Ç –ø–æ —Å—Å—ã–ª–∫–µ:
   ```
   https://t.me/dukhovnik_ai_bot?start=utm_source=yandex--yclid=1234567890
   ```
4. –ë–æ—Ç –∏–∑–≤–ª–µ–∫–∞–µ—Ç `yclid` –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –∫–∞–∫ `client_id` –≤ `user_data`
5. –ü—Ä–∏ –∫–æ–Ω–≤–µ—Ä—Å–∏–∏ (–∞–∫—Ç–∏–≤–∞—Ü–∏—è, –æ–ø–ª–∞—Ç–∞) –±–æ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –æ—Ñ—Ñ–ª–∞–π–Ω-–∫–æ–Ω–≤–µ—Ä—Å–∏—é —Å —Ç–µ–º –∂–µ `yclid`
6. –Ø–Ω–¥–µ–∫—Å.–ú–µ—Ç—Ä–∏–∫–∞ —Å–≤—è–∑—ã–≤–∞–µ—Ç –∫–ª–∏–∫ –∏ –∫–æ–Ω–≤–µ—Ä—Å–∏—é ‚Üí **–º–æ–∂–Ω–æ –ø–æ—Å—á–∏—Ç–∞—Ç—å ROI**

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –û—Ä–≥–∞–Ω–∏—á–µ—Å–∫–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å

1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ø—É—Å–∫–∞–µ—Ç –±–æ—Ç –±–µ–∑ UTM –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ (`/start`)
2. –ë–æ—Ç –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω—ã–π ClientID –Ω–∞ –æ—Å–Ω–æ–≤–µ `user_id`:
   ```python
   client_id = generate_client_id(user_id)  # UUID –Ω–∞ –æ—Å–Ω–æ–≤–µ user_id
   ```
3. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ `user_data['client_id']`
4. –ü—Ä–∏ –∫–æ–Ω–≤–µ—Ä—Å–∏–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —ç—Ç–æ—Ç –∂–µ ClientID

## üìä –ü—Ä–∏–º–µ—Ä—ã –ª–æ–≥–æ–≤

### –ü—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ —Å —Ä–µ–∫–ª–∞–º–æ–π:
```
ClientID –ø–æ–ª—É—á–µ–Ω –∏–∑ UTM –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –¥–ª—è user_id=123456: 9876543210fedcba
–ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å 123456 (@username) –∏–∑ –∏—Å—Ç–æ—á–Ω–∏–∫–∞: utm_source=yandex, utm_campaign=christmas, yclid=9876543210fedcba, ClientID=9876543210fedcba
‚úÖ –ö–æ–Ω–≤–µ—Ä—Å–∏—è bot_start —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –¥–ª—è user_id=123456, ClientID=9876543210fedcba
–û—Ñ—Ñ–ª–∞–π–Ω-–∫–æ–Ω–≤–µ—Ä—Å–∏—è 508977279 –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞: user_id=123456, ClientID=9876543210fedcba, price=0.0 RUB
```

### –ü—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ –æ—Ä–≥–∞–Ω–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
```
ClientID —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –¥–ª—è user_id=234567: a1b2c3d4-e5f6-7890-abcd-ef1234567890
–ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å 234567 (@user2) –∏–∑ –∏—Å—Ç–æ—á–Ω–∏–∫–∞: utm_source=organic, ClientID=a1b2c3d4-e5f6-7890-abcd-ef1234567890
‚úÖ –ö–æ–Ω–≤–µ—Ä—Å–∏—è bot_start —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –¥–ª—è user_id=234567, ClientID=a1b2c3d4-e5f6-7890-abcd-ef1234567890
```

### –ü—Ä–∏ –æ–ø–ª–∞—Ç–µ –ø–æ–¥–ø–∏—Å–∫–∏:
```
–û—Ñ—Ñ–ª–∞–π–Ω-–∫–æ–Ω–≤–µ—Ä—Å–∏—è premium_payment –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∞ –¥–ª—è user_id=123456, ClientID=9876543210fedcba, amount=149.0 RUB
‚úÖ –ö–æ–Ω–≤–µ—Ä—Å–∏—è premium_payment —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –¥–ª—è user_id=123456, ClientID=9876543210fedcba, price=149.0 RUB
–û—Ñ—Ñ–ª–∞–π–Ω-–∫–æ–Ω–≤–µ—Ä—Å–∏—è 508976841 –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞: user_id=123456, ClientID=9876543210fedcba, price=149.0 RUB
```

## ‚úÖ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

1. **–°–≤—è–∑—å —Ä–µ–∫–ª–∞–º—ã –∏ –∫–æ–Ω–≤–µ—Ä—Å–∏–π** - –Ø–Ω–¥–µ–∫—Å.–ú–µ—Ç—Ä–∏–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–≤—è–∑—ã–≤–∞–µ—Ç –∫–ª–∏–∫–∏ –ø–æ —Ä–µ–∫–ª–∞–º–µ —Å –∫–æ–Ω–≤–µ—Ä—Å–∏—è–º–∏ –≤ –±–æ—Ç–µ
2. **–†–∞—Å—á–µ—Ç ROI** - –º–æ–∂–Ω–æ –ø–æ—Å—á–∏—Ç–∞—Ç—å —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∫–∞–∂–¥–æ–π —Ä–µ–∫–ª–∞–º–Ω–æ–π –∫–∞–º–ø–∞–Ω–∏–∏
3. **–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –æ—Ä–≥–∞–Ω–∏—á–µ—Å–∫–æ–≥–æ —Ç—Ä–∞—Ñ–∏–∫–∞** - –¥–∞–∂–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –±–µ–∑ UTM –ø–æ–ª—É—á–∞—é—Ç —Å—Ç–∞–±–∏–ª—å–Ω—ã–π ClientID
4. **–û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å** - —Å—Ç–∞—Ä—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ª—É—á–∞—é—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π ClientID
5. **–î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** - –∫–∞–∂–¥–∞—è –∫–æ–Ω–≤–µ—Ä—Å–∏—è –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è —Å ClientID –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

## üõ†Ô∏è –ú–∏–≥—Ä–∞—Ü–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

–î–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –±–µ–∑ `client_id` –≤ –±–∞–∑–µ:

```python
# –í handlers/start.py –ø—Ä–∏ –ª—é–±–æ–º /start
if not user_data.get('client_id'):
    from core.yandex_metrika import generate_client_id
    user_data['client_id'] = generate_client_id(user_id)
    save_user_db()
```

–≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –≤—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ –ø–æ–ª—É—á–∞—Ç ClientID.

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- `yclid` –ø—Ä–∏–Ω–∏–º–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –∏–∑ –¥–æ–≤–µ—Ä–µ–Ω–Ω–æ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ (–ø–∞—Ä–∞–º–µ—Ç—Ä `/start`)
- ClientID –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç—Å—è –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –≤ –ú–µ—Ç—Ä–∏–∫—É
- –í—Å–µ –æ—à–∏–±–∫–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è, –Ω–æ –Ω–µ –≤–ª–∏—è—é—Ç –Ω–∞ —Ä–∞–±–æ—Ç—É –±–æ—Ç–∞
- –û—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–Ω–≤–µ—Ä—Å–∏–π –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ (`asyncio.create_task`)

## üìù –ö–æ–º–º–∏—Ç

```bash
git add -A
git commit -m "–¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–ª–Ω–∞—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø–µ—Ä–µ–¥–∞—á–∞ –æ—Ñ—Ñ–ª–∞–π–Ω-–∫–æ–Ω–≤–µ—Ä—Å–∏–π —Å ClientID"
git push origin main
```

## üéØ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å —Ä–µ–∫–ª–∞–º–Ω—ã–µ –∫–∞–º–ø–∞–Ω–∏–∏ –≤ –Ø–Ω–¥–µ–∫—Å.–î–∏—Ä–µ–∫—Ç —Å UTM-–º–µ—Ç–∫–∞–º–∏ –∏ `{YCLID}`
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É —á–µ—Ä–µ–∑ –ª–æ–≥–∏ –±–æ—Ç–∞: `grep "ClientID" /opt/dukhovnik_bot/bot.log`
3. –°–æ–∑–¥–∞—Ç—å –æ—Ç—á–µ—Ç—ã –≤ –Ø–Ω–¥–µ–∫—Å.–ú–µ—Ç—Ä–∏–∫–µ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ ROI
4. –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∫–ª–∞–º–Ω—ã–µ –∫–∞–º–ø–∞–Ω–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö –∫–æ–Ω–≤–µ—Ä—Å–∏–π
