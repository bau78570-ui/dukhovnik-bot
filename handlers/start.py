from aiogram import F, Router, Bot
from aiogram.filters import CommandStart, Command
from aiogram.types import Message, FSInputFile, CallbackQuery, InlineKeyboardMarkup, InlineKeyboardButton, ReplyKeyboardRemove
from aiogram.utils.keyboard import InlineKeyboardBuilder
from aiogram.fsm.context import FSMContext # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º FSMContext
from datetime import datetime # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º datetime
from core.content_sender import send_and_delete_previous, send_content_message # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –Ω–æ–≤—É—é —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é
from core.user_database import get_user, user_db, save_user_db # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º get_user, user_db –∏ save_user_db
from core.subscription_checker import is_premium # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º is_premium
import logging # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º logging
import asyncio # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º asyncio –¥–ª—è –∑–∞–¥–µ—Ä–∂–µ–∫

# –°–æ–∑–¥–∞–µ–º —Ä–æ—É—Ç–µ—Ä –¥–ª—è —ç—Ç–æ–≥–æ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞
router = Router()

@router.message(CommandStart())
async def command_start_handler(message: Message, bot: Bot, state: FSMContext) -> None:
    """
    –≠—Ç–æ—Ç –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –±—É–¥–µ—Ç —Å—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –Ω–∞ –∫–æ–º–∞–Ω–¥—É /start.
    –î–ª—è –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç 3-—Å–æ–æ–±—â–µ–Ω–∏–µ welcome-–æ–Ω–±–æ—Ä–¥–∏–Ω–≥.
    """
    # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
    user_id = message.from_user.id
    chat_id = message.chat.id
    
    # –ü–æ–ª—É—á–∞–µ–º –∏–ª–∏ —Å–æ–∑–¥–∞–µ–º –∑–∞–ø–∏—Å—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    user_data = get_user(user_id)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø—Ä–æ—à–µ–ª –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–Ω–±–æ—Ä–¥–∏–Ω–≥
    is_new_user = not user_data.get('onboarded', False)
    
    # –ü–æ–ª—É—á–∞–µ–º –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–∏
    user_name = message.from_user.first_name or "–¥—Ä—É–≥"
    
    # –°–Ω–∞—á–∞–ª–∞ —É–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ä—É—é –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É (—Å–±—Ä–æ—Å –∫—ç—à–∞ Telegram)
    await message.answer("‚ôªÔ∏è", reply_markup=ReplyKeyboardRemove())
    
    # === WELCOME-–û–ù–ë–û–†–î–ò–ù–ì –î–õ–Ø –ù–û–í–´–• –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô ===
    if is_new_user:
        logging.info(f"–ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} ({user_name}), –∑–∞–ø—É—Å–∫–∞–µ–º welcome-–æ–Ω–±–æ—Ä–¥–∏–Ω–≥")
        
        # –°–æ–æ–±—â–µ–Ω–∏–µ 1: –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º
        await bot.send_chat_action(chat_id, "typing")
        welcome_text = (
            f"üïäÔ∏è <b>–ú–∏—Ä –≤–∞–º, {user_name}!</b>\n\n"
            "–Ø ‚Äî <b>–î—É—Ö–æ–≤–Ω–∏–∫</b>, –≤–∞—à –ª–∏—á–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ –≤ –≤–æ–ø—Ä–æ—Å–∞—Ö –ø—Ä–∞–≤–æ—Å–ª–∞–≤–Ω–æ–π –≤–µ—Ä—ã –∏ –¥—É—Ö–æ–≤–Ω–æ–≥–æ —Ä–æ—Å—Ç–∞. üôè\n\n"
            "–Ø –∑–¥–µ—Å—å, —á—Ç–æ–±—ã –ø–æ–¥–¥–µ—Ä–∂–∞—Ç—å –≤–∞—Å –≤ –¥—É—Ö–æ–≤–Ω–æ–º –ø–æ–∏—Å–∫–µ, –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –∏ –ø–æ–º–æ—á—å –æ–±—Ä–µ—Å—Ç–∏ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –ø–æ–∫–æ–π.\n\n"
            "‚ú® <i>–ë–æ–ª–µ–µ 5000 –ø—Ä–∞–≤–æ—Å–ª–∞–≤–Ω—ã—Ö —Ö—Ä–∏—Å—Ç–∏–∞–Ω —É–∂–µ –¥–æ–≤–µ—Ä—è—é—Ç –º–Ω–µ —Å–≤–æ–∏ –º—ã—Å–ª–∏ –∏ –≤–æ–ø—Ä–æ—Å—ã.</i>"
        )
        await send_content_message(
            bot=bot,
            chat_id=chat_id,
            text=welcome_text,
            image_name='onboarding.png'
        )
        
        # –ó–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏
        await asyncio.sleep(2)
        
        # –°–æ–æ–±—â–µ–Ω–∏–µ 2: –ì–∞–π–¥ –ø–æ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è–º
        await bot.send_chat_action(chat_id, "typing")
        await asyncio.sleep(1.5)
        
        guide_text = (
            "üìö <b>–ß—Ç–æ —è —É–º–µ—é:</b>\n\n"
            "üí¨ <b>–ë–µ–∑–ª–∏–º–∏—Ç–Ω—ã–µ –±–µ—Å–µ–¥—ã —Å –ò–ò</b>\n"
            "–ó–∞–¥–∞–≤–∞–π—Ç–µ –ª—é–±—ã–µ –≤–æ–ø—Ä–æ—Å—ã –æ –≤–µ—Ä–µ, –ü–∏—Å–∞–Ω–∏–∏, —Ü–µ—Ä–∫–æ–≤–Ω–æ–π –∂–∏–∑–Ω–∏ ‚Äî –æ—Ç–≤–µ—á—É –ø–æ–Ω—è—Ç–Ω–æ –∏ —Å –æ–ø–æ—Ä–æ–π –Ω–∞ –ø—Ä–∞–≤–æ—Å–ª–∞–≤–Ω—É—é —Ç—Ä–∞–¥–∏—Ü–∏—é\n\n"
            "üìñ <b>–ï–∂–µ–¥–Ω–µ–≤–Ω–æ–µ ¬´–°–ª–æ–≤–æ –î–Ω—è¬ª</b>\n"
            "–ö–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 14:00 ‚Äî –≥–ª—É–±–æ–∫–∏–µ —Ä–∞–∑–º—ã—à–ª–µ–Ω–∏—è –∏ –≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏–µ –∏–∑ –°–≤—è—â–µ–Ω–Ω–æ–≥–æ –ü–∏—Å–∞–Ω–∏—è\n\n"
            "üóìÔ∏è <b>–ü—Ä–∞–≤–æ—Å–ª–∞–≤–Ω—ã–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å</b>\n"
            "–ü—Ä–∞–∑–¥–Ω–∏–∫–∏, –ø–æ—Å—Ç—ã, –∏–º–µ–Ω–∏–Ω—ã ‚Äî –≤—Å—ë –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ —Å –ø–æ–¥—Ä–æ–±–Ω—ã–º–∏ –æ–±—ä—è—Å–Ω–µ–Ω–∏—è–º–∏\n\n"
            "üôè <b>–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –º–æ–ª–∏—Ç–≤—ã</b>\n"
            "–°–æ—Å—Ç–∞–≤–ª—é –º–æ–ª–∏—Ç–≤—É —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ –¥–ª—è –≤–∞—à–µ–π —Å–∏—Ç—É–∞—Ü–∏–∏ ‚Äî –æ –∑–¥–æ—Ä–æ–≤—å–µ, —Å–µ–º—å–µ, —Ä–∞–±–æ—Ç–µ –∏–ª–∏ –¥—É—à–µ–≤–Ω–æ–º –ø–æ–∫–æ–µ\n\n"
            "‚öôÔ∏è <b>–£–º–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</b>\n"
            "–£—Ç—Ä–µ–Ω–Ω–µ–µ –≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏–µ (8:00), –¥–Ω–µ–≤–Ω–æ–µ —Å–ª–æ–≤–æ (14:00) –∏ –≤–µ—á–µ—Ä–Ω–∏–µ —Ä–∞–∑–º—ã—à–ª–µ–Ω–∏—è (20:00)\n\n"
            "üéÅ <b>–í—Å—ë —ç—Ç–æ –ë–ï–°–ü–õ–ê–¢–ù–û –ø–µ—Ä–≤—ã–µ 3 –º–µ—Å—è—Ü–∞!</b>\n"
            "–ü–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π ‚Äî –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –∏ —É–±–µ–¥–∏—Ç–µ—Å—å —Å–∞–º–∏."
        )
        await message.answer(guide_text, parse_mode='HTML')
        
        # –ó–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ –ø—Ä–∏–∑—ã–≤–æ–º –∫ –¥–µ–π—Å—Ç–≤–∏—é
        await asyncio.sleep(2)
        
        # –°–æ–æ–±—â–µ–Ω–∏–µ 3: –ü—Ä–∏–∑—ã–≤ –∫ –¥–µ–π—Å—Ç–≤–∏—é —Å –∫–Ω–æ–ø–∫–∞–º–∏
        await bot.send_chat_action(chat_id, "typing")
        await asyncio.sleep(1)
        
        # –°–æ–∑–¥–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –±—ã—Å—Ç—Ä—ã–º–∏ –¥–µ–π—Å—Ç–≤–∏—è–º–∏
        action_builder = InlineKeyboardBuilder()
        action_builder.button(text="üéÅ –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å 3 –º–µ—Å—è—Ü–∞ –±–µ—Å–ø–ª–∞—Ç–Ω–æ", callback_data="activate_free_period")
        action_builder.button(text="üí¨ –ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å –î—É—Ö–æ–≤–Ω–∏–∫—É", callback_data="start_chat")
        action_builder.button(text="üóìÔ∏è –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∫–∞–ª–µ–Ω–¥–∞—Ä—å", callback_data="show_calendar")
        action_builder.adjust(1)
        
        call_to_action = (
            "üöÄ <b>–ù–∞—á–Ω–∏—Ç–µ –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å!</b>\n\n"
            "üîπ –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã <b>–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å 3 –º–µ—Å—è—Ü–∞ –±–µ—Å–ø–ª–∞—Ç–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞</b>\n"
            "üîπ –ò–ª–∏ –ø—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏—Ç–µ –º–Ω–µ —Å–≤–æ–π –≤–æ–ø—Ä–æ—Å ‚Äî —è —É–∂–µ –≥–æ—Ç–æ–≤ –ø–æ–º–æ—á—å!\n\n"
            "üí° <b>–ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç:</b>\n"
            "‚Ä¢ –ö–æ–º–∞–Ω–¥–∞ /dukhovnik ‚Äî –Ω–∞—á–∞—Ç—å –±–µ—Å–µ–¥—É\n"
            "‚Ä¢ –ö–æ–º–∞–Ω–¥–∞ /prayer ‚Äî —Å–æ–∑–¥–∞—Ç—å –º–æ–ª–∏—Ç–≤—É\n"
            "‚Ä¢ –ö–æ–º–∞–Ω–¥–∞ /calendar ‚Äî –ø—Ä–∞–≤–æ—Å–ª–∞–≤–Ω—ã–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å\n"
            "‚Ä¢ –ö–æ–º–∞–Ω–¥–∞ /subscribe ‚Äî –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –¥–æ—Å—Ç—É–ø\n\n"
            "üì¢ <b>–ü–æ–¥–µ–ª–∏—Ç–µ—Å—å –±–æ—Ç–æ–º —Å –¥—Ä—É–∑—å—è–º–∏!</b>\n"
            "–ü–æ–º–æ–≥–∏—Ç–µ –±–ª–∏–∑–∫–∏–º –Ω–∞–π—Ç–∏ –¥—É—Ö–æ–≤–Ω—É—é –ø–æ–¥–¥–µ—Ä–∂–∫—É ‚Äî –ø—É—Å—Ç—å –æ–Ω–∏ —Ç–æ–∂–µ –ø–æ–ª—É—á–∞—Ç 3 –º–µ—Å—è—Ü–∞ –±–µ—Å–ø–ª–∞—Ç–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞.\n\n"
            "üôè <i>–î–∞ —Ö—Ä–∞–Ω–∏—Ç –≤–∞—Å –ì–æ—Å–ø–æ–¥—å –Ω–∞ –≤—Å–µ—Ö –ø—É—Ç—è—Ö –≤–∞—à–∏—Ö!</i>"
        )
        
        await message.answer(
            call_to_action,
            reply_markup=action_builder.as_markup(),
            parse_mode='HTML'
        )
        
        # –û—Ç–º–µ—á–∞–µ–º, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—à–µ–ª –æ–Ω–±–æ—Ä–¥–∏–Ω–≥
        user_data['onboarded'] = True
        user_data['onboarded_date'] = datetime.now()
        save_user_db()
        
        logging.info(f"Welcome-–æ–Ω–±–æ—Ä–¥–∏–Ω–≥ –∑–∞–≤–µ—Ä—à–µ–Ω –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}")
        return
    
    # === –°–¢–ê–ù–î–ê–†–¢–ù–´–ô /START –î–õ–Ø –í–ï–†–ù–£–í–®–ò–•–°–Ø –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô ===
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    from core.subscription_checker import is_trial_active, is_subscription_active, is_free_period_active
    
    trial_was_activated = user_data.get('trial_start_date') is not None
    trial_is_active = await is_trial_active(user_id)
    has_subscription = await is_subscription_active(user_id)
    has_free_period = await is_free_period_active(user_id)
    
    # –û—Ç–ø—Ä–∞–≤–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–π –ø–æ–¥–ø–∏—Å—å—é
    welcome_caption = (
        f"üïäÔ∏è <b>–° –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ–º, {user_name}!</b>\n\n"
        "–Ø ‚Äî <b>–î—É—Ö–æ–≤–Ω–∏–∫</b>, –≤–∞—à —Ü–∏—Ñ—Ä–æ–≤–æ–π —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫ –≤ –≤–æ–ø—Ä–æ—Å–∞—Ö –≤–µ—Ä—ã. "
        "–Ø –∑–¥–µ—Å—å, —á—Ç–æ–±—ã –ø–æ–º–æ—á—å –∏ –ø–æ–¥–¥–µ—Ä–∂–∞—Ç—å –≤–∞—Å –≤ –¥—É—Ö–æ–≤–Ω–æ–º –ø–æ–∏—Å–∫–µ."
    )
    await send_content_message(
        bot=bot,
        chat_id=chat_id,
        text=welcome_caption,
        image_name='onboarding.png'
    )

    # –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∏—Å–∫–ª–µ–π–º–µ—Ä–∞ –∏ –∫–Ω–æ–ø–æ–∫
    builder = InlineKeyboardBuilder()
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –±–µ—Å–ø–ª–∞—Ç–Ω–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞, –µ—Å–ª–∏ –æ–Ω –µ—â–µ –Ω–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω
    free_period_start = user_data.get('free_period_start')
    if free_period_start is None:
        builder.button(text="üéÅ –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å 3 –º–µ—Å—è—Ü–∞ –±–µ—Å–ø–ª–∞—Ç–Ω–æ", callback_data="activate_free_period")
    # –ò–ª–∏ –∫–Ω–æ–ø–∫—É –ø—Ä–æ–±–Ω–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞, –µ—Å–ª–∏ –æ–Ω –µ—â–µ –Ω–µ –±—ã–ª –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω
    elif not trial_was_activated:
        builder.button(text="‚úÖ –ù–∞—á–∞—Ç—å 3 –¥–Ω—è –±–µ—Å–ø–ª–∞—Ç–Ω–æ", callback_data="start_trial")
    
    builder.button(text="üìÑ –£—Å–ª–æ–≤–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è", url="https://teletype.in/@doc_content/IWP-06AxhyO")
    builder.adjust(1)

    disclaimer_text = (
        "<i>–í–∞–∂–Ω–æ: –Ø ‚Äî –Ω–µ–π—Ä–æ—Å–µ—Ç—å, –∞ –Ω–µ —Å–≤—è—â–µ–Ω–Ω–∏–∫. –ú–æ–∏ –æ—Ç–≤–µ—Ç—ã –æ—Å–Ω–æ–≤–∞–Ω—ã –Ω–∞ –ø—Ä–∞–≤–æ—Å–ª–∞–≤–Ω—ã—Ö —É—á–µ–Ω–∏—è—Ö –∏ —Ç–µ–∫—Å—Ç–∞—Ö, "
        "–Ω–æ –Ω–µ —è–≤–ª—è—é—Ç—Å—è –∫–∞–Ω–æ–Ω–∏—á–µ—Å–∫–∏–º–∏ —É–∫–∞–∑–∞–Ω–∏—è–º–∏ –∏ –Ω–µ –∑–∞–º–µ–Ω—è—é—Ç –¢–∞–∏–Ω—Å—Ç–≤ –¶–µ—Ä–∫–≤–∏ –∏ –∂–∏–≤–æ–≥–æ –æ–±—â–µ–Ω–∏—è —Å –¥—É—Ö–æ–≤–Ω–∏–∫–æ–º. "
        "–ü—Ä–æ–µ–∫—Ç —è–≤–ª—è–µ—Ç—Å—è —á–∞—Å—Ç–Ω–æ–π –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤–æ–π –∏ –Ω–µ —Å–≤—è–∑–∞–Ω —Å –†–ü–¶.</i>"
    )
    
    # –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    if has_subscription:
        status_text = "üéâ –£ –≤–∞—Å –∞–∫—Ç–∏–≤–Ω–∞ Premium-–ø–æ–¥–ø–∏—Å–∫–∞! –í—ã –º–æ–∂–µ—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –≤—Å–µ–º–∏ —Ñ—É–Ω–∫—Ü–∏—è–º–∏ –±–æ—Ç–∞."
    elif has_free_period:
        status_text = "‚ú® –£ –≤–∞—Å –∞–∫—Ç–∏–≤–µ–Ω –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –ø–µ—Ä–∏–æ–¥ –Ω–∞ 3 –º–µ—Å—è—Ü–∞! –ù–∞—Å–ª–∞–∂–¥–∞–π—Ç–µ—Å—å –≤—Å–µ–º–∏ —Ñ—É–Ω–∫—Ü–∏—è–º–∏ –±–æ—Ç–∞."
    elif trial_is_active:
        status_text = "‚úÖ –£ –≤–∞—Å –∞–∫—Ç–∏–≤–µ–Ω –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –ø—Ä–æ–±–Ω—ã–π –ø–µ—Ä–∏–æ–¥. –í—ã –º–æ–∂–µ—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –≤—Å–µ–º–∏ —Ñ—É–Ω–∫—Ü–∏—è–º–∏ –±–æ—Ç–∞."
    elif trial_was_activated:
        status_text = "üí≥ –í–∞—à –ø—Ä–æ–±–Ω—ã–π –ø–µ—Ä–∏–æ–¥ –∏—Å—Ç–µ–∫. –î–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è Premium-—Ñ—É–Ω–∫—Ü–∏–π –æ—Ñ–æ—Ä–º–∏—Ç–µ –ø–æ–¥–ø–∏—Å–∫—É: /subscribe"
    else:
        status_text = "–í—ã –º–æ–∂–µ—Ç–µ –Ω–∞—á–∞—Ç—å –Ω–∞—à —Ä–∞–∑–≥–æ–≤–æ—Ä –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å. –ê–∫—Ç–∏–≤–∏—Ä—É–π—Ç–µ –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –ø–µ—Ä–∏–æ–¥ –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫–æ –≤—Å–µ–º —Ñ—É–Ω–∫—Ü–∏—è–º."

    info_text = f"{disclaimer_text}\n\n{status_text}"

    await message.answer(
        text=info_text,
        reply_markup=builder.as_markup(),
        parse_mode='HTML'
    )



@router.callback_query(F.data == "start_trial")
async def start_trial_handler(query: CallbackQuery, bot: Bot, state: FSMContext):
    """
    –≠—Ç–æ—Ç –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –±—É–¥–µ—Ç —Å—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –Ω–∞ –Ω–∞–∂–∞—Ç–∏–µ –∏–Ω–ª–∞–π–Ω-–∫–Ω–æ–ø–∫–∏
    —Å callback_data="start_trial" –∏ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–±–Ω—ã–π –ø–µ—Ä–∏–æ–¥.
    """
    user_id = query.from_user.id
    from core.subscription_checker import activate_trial, TRIAL_DURATION_DAYS # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –∑–¥–µ—Å—å, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å —Ü–∏–∫–ª–∏—á–µ—Å–∫–æ–≥–æ –∏–º–ø–æ—Ä—Ç–∞

    if await activate_trial(user_id):
        await query.message.edit_text(
            text=f"üéâ <b>–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º!</b> –í–∞—à –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –ø—Ä–æ–±–Ω—ã–π –ø–µ—Ä–∏–æ–¥ –Ω–∞ {TRIAL_DURATION_DAYS} –¥–Ω—è –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω.\n"
                 "–¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –≤—Å–µ–º–∏ —Ñ—É–Ω–∫—Ü–∏—è–º–∏ –±–æ—Ç–∞ –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π!",
            parse_mode='HTML'
        )
    else:
        await query.message.edit_text(
            text="–í—ã —É–∂–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–ª–∏ –ø—Ä–æ–±–Ω—ã–π –ø–µ—Ä–∏–æ–¥ —Ä–∞–Ω–µ–µ –∏–ª–∏ –æ–Ω –∏—Å—Ç–µ–∫. "
                 "–î–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è Premium-—Ñ—É–Ω–∫—Ü–∏–π, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ñ–æ—Ä–º–∏—Ç–µ –ø–æ–¥–ø–∏—Å–∫—É: /subscribe",
            parse_mode='HTML'
        )
    await query.answer()


@router.callback_query(F.data == "start_chat")
async def start_chat_handler(query: CallbackQuery, bot: Bot):
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å –î—É—Ö–æ–≤–Ω–∏–∫—É" –∏–∑ –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞.
    """
    await query.answer()
    
    chat_prompt = (
        "üí¨ <b>–ì–æ—Ç–æ–≤ –∫ –±–µ—Å–µ–¥–µ!</b>\n\n"
        "–ó–∞–¥–∞–π—Ç–µ –º–Ω–µ –ª—é–±–æ–π –≤–æ–ø—Ä–æ—Å –æ –ø—Ä–∞–≤–æ—Å–ª–∞–≤–Ω–æ–π –≤–µ—Ä–µ, –ü–∏—Å–∞–Ω–∏–∏, –º–æ–ª–∏—Ç–≤–∞—Ö, –¥—É—Ö–æ–≤–Ω–æ–π –∂–∏–∑–Ω–∏ –∏–ª–∏ —Ü–µ—Ä–∫–æ–≤–Ω—ã—Ö —Ç—Ä–∞–¥–∏—Ü–∏—è—Ö.\n\n"
        "–Ø –æ—Ç–≤–µ—á—É –ø–æ–Ω—è—Ç–Ω–æ, —Å –æ–ø–æ—Ä–æ–π –Ω–∞ –ø—Ä–∞–≤–æ—Å–ª–∞–≤–Ω–æ–µ —É—á–µ–Ω–∏–µ.\n\n"
        "–¢–∞–∫–∂–µ –º–æ–∂–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–æ–º–∞–Ω–¥—É /dukhovnik –≤ –ª—é–±–æ–π –º–æ–º–µ–Ω—Ç."
    )
    
    await query.message.answer(chat_prompt, parse_mode='HTML')
    logging.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {query.from_user.id} –Ω–∞—á–∞–ª –±–µ—Å–µ–¥—É —á–µ—Ä–µ–∑ –æ–Ω–±–æ—Ä–¥–∏–Ω–≥")


@router.callback_query(F.data == "show_calendar")
async def show_calendar_from_onboarding_handler(query: CallbackQuery, bot: Bot):
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∫–∞–ª–µ–Ω–¥–∞—Ä—å" –∏–∑ –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞.
    –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ –∏ –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –∫–æ–º–∞–Ω–¥—É.
    """
    await query.answer()
    
    calendar_info = (
        "üóìÔ∏è <b>–ü—Ä–∞–≤–æ—Å–ª–∞–≤–Ω—ã–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å</b>\n\n"
        "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /calendar —á—Ç–æ–±—ã —É–∑–Ω–∞—Ç—å:\n"
        "‚Ä¢ –ö–∞–∫–æ–π —Å–µ–≥–æ–¥–Ω—è —Ü–µ—Ä–∫–æ–≤–Ω—ã–π –ø—Ä–∞–∑–¥–Ω–∏–∫\n"
        "‚Ä¢ –ü–æ—Å—Ç –∏–ª–∏ –Ω–µ—Ç\n"
        "‚Ä¢ –ß—å–∏ —Å–µ–≥–æ–¥–Ω—è –∏–º–µ–Ω–∏–Ω—ã\n"
        "‚Ä¢ –ï–≤–∞–Ω–≥–µ–ª—å—Å–∫–æ–µ —á—Ç–µ–Ω–∏–µ –¥–Ω—è\n\n"
        "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å: /calendar"
    )
    
    await query.message.answer(calendar_info, parse_mode='HTML')
    logging.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {query.from_user.id} –∑–∞–ø—Ä–æ—Å–∏–ª –∫–∞–ª–µ–Ω–¥–∞—Ä—å —á–µ—Ä–µ–∑ –æ–Ω–±–æ—Ä–¥–∏–Ω–≥")
